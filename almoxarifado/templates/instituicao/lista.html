{% extends 'base.html' %} {% load static %} {% block content %}
<h1>Almoxerifado</h1>
<div>
  <div>
    <div
      class="d-flex align-items-center mb-3"
      style="justify-content: space-between"
    >
      <input
        type="text"
        placeholder="Pesquisar Instituição"
        class="form-control w-50"
      />
      <a href="{% url 'add_instituicao' %}" class="btn btn-primary right-5"
        >Adicionar Instituição</a
      >
      <a
        href="{% url 'pdf_instituicao' %}?download=pdf"
        id="exportPdfBtn"
        class="btn btn-secondary"
        >Exportar PDF</a
      >
    </div>
    <div>
      <table class="table table-striped">
        <thead>
          <tr>
            <th>Nome</th>
            <th>CEP</th>
            <th>Logradouro</th>
            <th>Número</th>
            <th>Bairro</th>
            <th>Estado</th>
            <th>Telefone</th>
            <th>CNPJ</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody>
          {% for instituicao in instituicoes %}
          <tr>
            <td>{{ instituicao.nome }}</td>
            <td>{{ instituicao.cep }}</td>
            <td>{{ instituicao.logradouro }}</td>
            <td>{{ instituicao.numero }}</td>
            <td>{{ instituicao.bairro }}</td>
            <td>{{ instituicao.estado }}</td>
            <td>{{ instituicao.telefone }}</td>
            <td>{{ instituicao.cnpj }}</td>
            <td>
              <a
                href="{% url 'editar-instituicao' instituicao.pk %}"
                class="btn btn-sm"
                >Editar</a
              >
              <a
                href="{% url 'excluir-instituicao' instituicao.pk %}"
                class="btn btn-sm"
                >Excluir</a
              >
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="9" class="text-center">
              Nenhuma instituição cadastrada
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
<!-- Exclusão agora é feita via POST, sem JS -->
{% endblock content %}

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const btn = document.getElementById("exportPdfBtn");
    if (!btn) return;
    btn.addEventListener("click", async function (e) {
      e.preventDefault();
      const url = btn.href;
      try {
        const resp = await fetch(url, { credentials: "same-origin" });
        if (!resp.ok) {
          // fallback: abrir em nova aba
          window.open(url, "_blank");
          return;
        }
        const blob = await resp.blob();
        const disposition = resp.headers.get("Content-Disposition") || "";
        let filename = "instituicoes.pdf";
        const match = /filename\*=UTF-8''([^;]+)|filename="?([^";]+)"?/i.exec(
          disposition
        );
        if (match) {
          filename = decodeURIComponent(match[1] || match[2]);
        }
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        link.remove();
        URL.revokeObjectURL(link.href);
      } catch (err) {
        console.error("Erro ao baixar PDF", err);
        window.open(url, "_blank");
      }
    });
  });
</script>
